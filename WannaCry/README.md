# WannaCry

## Introduction

### Credits
Being first "real" reverse-engineered project, I didn't know really well how to do some things, I decided to look online, and I came across someone that was doing the same thing! Definately check him out:
- Youtube: [stacksmashing](https://youtube.com/@stacksmashing)

### A small WannaCry history
WannaCry is a well-known ransomware that was first discovered on May 12, 2017. It swiftly spread across the globe, infecting hundreds of thousands of computers in over 150 countries. The ransomware specifically targeted computers running the Microsoft Windows operating system, especially those lacking the necessary security updates.

WannaCry took advantage of a vulnerability in the Windows operating system known as EternalBlue. This vulnerability was initially developed by the United States National Security Agency (NSA) and later utilized by a group called the Shadow Brokers. By exploiting this vulnerability, WannaCry rapidly propagated through networks, targeting vulnerable systems and encrypting files, rendering them inaccessible to users. Once infected, victims were presented with a ransom note demanding payment in Bitcoin in exchange for the decryption key.

The primary method of initial infection for WannaCry was through phishing emails and malicious attachments. Once inside a network, it leveraged the EternalBlue exploit to propagate and infect other vulnerable systems. This aggressive spreading mechanism greatly contributed to the swift and extensive reach of the attack.

More details can be found on [this wikipedia page](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack).

### Malware files
Those are the malware files:
-   0466c30d11752dc81e27fd20d12ba53b418ee88fc4fed4e1a1b41a2016ede294.exe (WannaCry dropper)
-   Tasksche.exe (Actual ransomware)
-   wnry.XIA (Zip file containing file dropped by Tasksche.exe)

### My files
Those are the files that I used to reverse engineer the malware
-   0466c30d11752dc81e27fd20d12ba53b418ee88fc4fed4e1a1b41a2016ede294.json (OOAnalyzer generated file)
-   Tasksche.json (OOAnalyzer generated file)
-   wnry (Just the extracted zip folder, containing the malware files)
-   WANNACRY (My Ghidra project folder)

## 0466c30d11752dc81e27fd20d12ba53b418ee88fc4fed4e1a1b41a2016ede294.exe
This file serves as the dropper for the malware. 

### Killswitch
The first thing WannaCry tries to do, is checking if the following url exist:
-   "**http://www.ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.com**"

If the URL exists, the dropper does not proceed with any further actions. This URL acts as a killswitch, preventing the infection from spreading when it was unregistered. 

If the URL doesn't exist, the dropper proceeds with the infection process. 

### No parameters
First, it checks if it was launched with argumes, if not it creates a service with this details:
-   Service Name:       "mssecsvc2.0"
-   Descryption:        "Microsoft Security Center (2.0)"
-   Binary path name:   "***malware.exe*** -m security"

Note that the service purpose is to launch the malware with 2 parameters.

Then the malware, drops the tasksche.exe file from the resource number 1831, and it puts it in the "C:\Windows\qeriuwjhrf" folder. Then, tasksche.exe gets executed with /i parameter.

### Parameters
When the malware is executed with the "-m security" parameters, it attempts to obtain a handle to the Service Control Manager. The purpose of this is to modify the Failure Actions of the mssecsvc2.0 service.

Then, a thread that will handle the Service Control requests is created, and connected to the SCManager.
That's all the dropped does, now let's jump into tasksche.exe

## Tasksche.exe 
This file is responsible for dropping a zip archive that contains an encrypted DLL. 
 
### Details 
tasksche.exe has the following attributes: 
-   CompanyName:        "Microsoft Corporation" 
-   FileDescription:    "DiskPart" 
-   FileVersion:        "6.1.7601.17514 (win7sp1_rtm. 101119-1850)" 
-   Internal name:      "diskpart.exe" 
-   LegalCopyright:     "© Microsoft Corporation. All rights reserved." 
-   OriginalFilename:   "diskpart.exe" 
-   ProductName:        "Microsoft® Windows® Operating System" 
-   ProductVersion:     "6.1.7601.17514" 
-   Translation:        "4b00409" 
 
### "/i" parameter 
When tasksche.exe is launched with the "/i" parameter, it obtains its file path and generates a random string. It then copies itself to "***windowsdir***\ProgramData\\***randomstring***" or "***windowsdir***\ProgramData\Intel\\***randomstring***", creating hidden directories marked as system ones. It also attempts to create a service with the following details: 
-   Service Name: "***randomstring***" 
-   Description: "***randomstring***" 
-   Binary path name: path to the dropped file 
    
If the service already exists, it simply starts it. It then tries to open the "Global\MsWinZonesCacheCounterMutexA0" mutex. After that, it attempts to create a process that launches itself without the "/i" parameter. It then makes another attempt to access the mutex. The mutex ensures that it doesn't run multiple times. 
 
### No parameters 
If the file is not executed with a parameter, it extracts an integrated resource with number 2058 and decrypts the XIA (zip) file using the password "WNcry@2ol7". It then hides all the files in the directory and grants them full authorizations. 
 
After that, the malware uses the Windows Crypto API to generate a key that will be used to decrypt 256 bytes after the first 12 from the t.wnry file. The first 16 bytes of the decrypted content are then used to decrypt the rest of the t.wnry file, starting from the 280th byte. This results in a DLL file.

### The XIA file
The extracted resource, with the XIA extension contains the following files:
-   b.wnry:             A bitmap file, the desktop wallpaper
-   c.wnry:             A text file containing some urls
-   r.wnry:             A text file containing WannaCry's decryption instructions
-   s.wnry:             A zip archive
-   t.wnry:             The file used to extract the DLL
-   u.wnry:             An executable file
-   taskdl.exe:         An executable file
-   taskse.exe:         An executable file
-   msg:                A folder containing language files

## Taskdl.exe
There is no much to say about this file, for what I was able to see, it simply deletes all .WNCRYT files on the detected drives.

### Details
The file has the following attributes:
-   CompanyName:         "Microsoft Corporation"
-   FileDescription:     "SQL Client Configuration Utility EXE"
-   FileVersion:         "6.1.7600.16385 (win7_rtm.090713-1255)"
-   Internal name:       "cliconfg.exe"
-   LegalCopyright:      "© Microsoft Corporation. All rights reserved."
-   OriginalFilename:    "cliconfg.exe"
-   ProductName:         "Microsoft@ Windows® Operating System"
-   ProductVersion:      "6.1.7600.16385"
-   Translation:         "4600409"

## Taskse.exe
This executable firstly enumerates all Windows RDP (Remote Desktop Protocol) sessions and then launches the decryptor on all of them with a duplicated user token.

### Details
This file has the following attributes:
-   CompanyName:        "Microsoft Corporation"
-   FileDescription:    "waitfor - wait/send a signal over a network"
-   FileVersion:        "6.1.7600.16385 (win7_rtm.090713-1255)"
-   Interna lame:       "waitfor.exe"
-   LegalCopyright:     "© Microsoft Corporation. All rights reserved."
-   OriginalFilename:   "waitfor.exe"
-   ProductName:        "Microsoft® Windows® Operating System"
-   ProductVersion:     "6.1.7600.16385"
-   Translation:        "4600409"

## u.wnry
This is the decryption tool, also known as *WanaDecrypt0r*.

### Details
The file has the following attributes:
-   CompanyName:        "Microsoft Corporation"
-   FileDescription:    "Load PerfMon Counters"
-   FileVersion:        "6.1.7600.16385 (win7_rtm.090713-1255)"
-   Internal name:       "LODCTR.EXE"
-   LegalCopyright:     "© Microsoft Corporation. All rights reserved."
-   OriginalFilename:   "LODCTR.EXE"
-   ProductName:        "Microsoft® Windows® Operating System"
-   ProductVersion:     "6.1.7600.16385"
-   Translation:        "4b00409"

### Behavior
The decryptor file uses a generated list called f.wnry where that contains the file crypted with an embedded key, that will be decrypted as a demonstration. All the other files are crypted with an AES key.

## t.wnry
This is the file that contains an embedded DLL.

### Details
The file has the following attributes:
-   CompanyName:        "Microsoft Corporation"
-   FileDescription:    "Latvia Keyboard Layout"
-   FileVersion:        "6.1.7600.16385 (win7_rtm.090713-1255)"
-   Internal name:       "kbdlv (3.13)"
-   LegalCopyright:     "© Microsoft Corporation. All rights reserved."
-   OriginalFilename:   "kbdlv.dll"
-   ProductName:        "Microsoft® Windows® Operating System"
-   ProductVersion:     "6.1.7600.16385"
-   Translation:        "4600000"

### Behavior