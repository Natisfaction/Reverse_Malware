# Petya

## Introduction

### A short Petya history
Petya is a family of encrypting malware that was first discovered in 2016. The malware targets Microsoft Windows–based systems, infecting the master boot record to execute a payload that encrypts a hard drive's file system table and prevents Windows from booting. It subsequently demands that the user make a payment in Bitcoin in order to regain access to the system.

Variants of Petya were first seen in March 2016, which propagated via infected e-mail attachments. In June 2017, a new variant of Petya was used for a global cyberattack, primarily targeting Ukraine. The new variant propagates via the EternalBlue exploit, which is generally believed to have been developed by the U.S. National Security Agency (NSA), and was used earlier in the year by the WannaCry ransomware.

Kaspersky Lab referred to this new version as NotPetya to distinguish it from the 2016 variants, due to these differences in operation. It looked like ransomware, but without functioning recovery feature it was equivalent to a wiper. The NotPetya attacks have been blamed on the Russian government, specifically the Sandworm hacking group within the GRU Russian military intelligence organization, by security researchers, Google, and several governments.

As always, more information can be found in [this wikipedia page](https://en.wikipedia.org/wiki/Petya_and_NotPetya).

### Malware files
Inside of the named folders those are the malware files:
-   4c1dc737915d76b7ce579abddaba74ead6fdb5b519a1ea45308b8c49b950655c.exe (Original Petya)
-   2a2a4e8ac8a25f27a49b5f25d4af953050474f468d32540f1e2a0f7e81f67556.exe (Green Petya, Micha)
-   389a7d395492c2da6f8abf5a8a7c49c3482f7844f77fe681808c71e961bcae97.exe (GoldenEye)

I did not include NotPetya (or Netya, EternalPetya), because it's not an official version of the malware.
However, I did reverse engineered this malware too, you can look it [here](https://github.com/Natisfaction/Reverse_Malware/tree/main/NotPetya).

### My files
-   *.json (OOAnalyzer generated files)

## Disclaimer
I won't be analyzing the Main malware module (the exe file), but I will be analyzing the most interesting part, the MBR payload. However, in my Ghidra folder you'll find the Malware reverse engineered as well as I could do... (right now still work in progress)...

### Behavior
Just so I don't have to write in all the malware category (and due to the fact that all the malware have pretty much the same infection beharior), after the main system infection, the malware will crash the system, in attempt to make it reboot, after that a fake CHKDSK screen will be displayed, in reality this is the malware MBR payload encrypting the MFT.
![FakeCHKSDK](https://github.com/Natisfaction/Reverse_Malware/blob/main/Petya/README_IMAGES/FakeCHKDSK.png)

## 4c1dc737915d76b7ce579abddaba74ead6fdb5b519a1ea45308b8c49b950655c.exe
This is the first original Petya ransomware.

## 2a2a4e8ac8a25f27a49b5f25d4af953050474f468d32540f1e2a0f7e81f67556.exe
This is the Green Petya ransomware variant, also known as Micha.

## 389a7d395492c2da6f8abf5a8a7c49c3482f7844f77fe681808c71e961bcae97.exe
This is the GoldenEye Petya ransomware variant.

## MBR Payload
When the PC crashes, it's disk state is the following:
-   Sector 0x0: Petya's malicious MBR
-   Sectors 0x1 to 0x21: some sectors XORed 0x37
-   Sectors 0x22 to 0x35: Petya's main payload
-   Sector 0x36: Encryption key (destroyed after encryption), Nonce, Verification flag, Tor addresses and Victim's ID
-   Sector 0x37: Sector filled with 0x37
-   Sector 0x38: Original MBR XORed with 0x37
-   Sector 0x39: Zeroed

### Sector 0x36
Inside sector 0x36, there are 3 main malware things:
-   A byte, that checks if the malware hasn't encrypted the drive yet (set to 0), if the drive is encrypted (1), if the drive has been decrypted (2)
-   Petya's 32 bytes Salsa20 encryption key
-   Petya's 8 bytes Salsa20 nonce

And other things such as:
-   Tor onion's urls (to pay the ransom)
-   The victim's ID

### Encryption process
If the flag is set to 0, the malware displays a fake CHKSDK screen, that sets instantly the flag to 1, then during the fake screen the malware encrypts the MFT with the Salsa20 key and Salsa20 nonce. After that, the malware causes a soft reboot of the system, displaying the ransom note.

### Decryption process
If the entered key is valid (I'll talk more about the key later on...), the malware tries to decrypt the sector 0x37, and if ALL the bytes inside the sector are 0x37, the key is valid and the malware starts to decrypt the disk.
After that, the flag is set to 2, the malware restores the original MBR and the disk is then booted normally.

## Decryption notes
I just wanted to mention that now it's possible to recover the files encrypted by ALL those official Petya versions, thanks to Janus (the malware author), the private key has beign released and can be used to decrypt the files. However, some really skilled dudes have found a way from some "bad implementations" of the encryption algorithm some ways to guess the key anyways...

### Janus statemens:
Congratulations!
Here is our secp192k1 privkey:
**38dd46801ce61883433048d6d8c6ab8be18654a2695b4723**
We used ECIES (with AES-256-ECB) Scheme to encrypt the decryption password into the "Personal Code" which is BASE58 encoded.

Information gathered from [Malwarebytes blog](https://www.malwarebytes.com/blog/news/2017/07/the-key-to-the-old-petya-has-been-published-by-the-malware-author).