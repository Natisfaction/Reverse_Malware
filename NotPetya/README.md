# NotPetya

## Introduction
This is my first malware analysis without ANY external help (ex. a youtube video), so please be patient if there are some error in the reverse engineered code.

### A short NotPetya history
Petya is a family of encrypting malware that was first discovered in 2016. The malware targets Microsoft Windowsâ€“based systems, infecting the master boot record to execute a payload that encrypts a hard drive's file system table and prevents Windows from booting. It subsequently demands that the user make a payment in Bitcoin in order to regain access to the system.

Variants of Petya were first seen in March 2016, which propagated via infected e-mail attachments. In June 2017, a new variant of Petya was used for a global cyberattack, primarily targeting Ukraine. The new variant propagates via the EternalBlue exploit, which is generally believed to have been developed by the U.S. National Security Agency (NSA), and was used earlier in the year by the WannaCry ransomware.

Kaspersky Lab referred to this new version as NotPetya to distinguish it from the 2016 variants, due to these differences in operation. It looked like ransomware, but without functioning recovery feature it was equivalent to a wiper. The NotPetya attacks have been blamed on the Russian government, specifically the Sandworm hacking group within the GRU Russian military intelligence organization, by security researchers, Google, and several governments.

As always, more information can be found in [this wikipedia page](https://en.wikipedia.org/wiki/Petya_and_NotPetya).

### Malware files
-   63545fa195488ff51955f09833332b9660d18f8afb16bdf579134661962e548a.exe (NotPetya DLL "launcher")
-   perfc.dat (Actual DLL payload)
-   4ACF.tmp (The credential stealer, used by the malware to steal User credentials)
-   dllhost.dat (Utility used to spread itself)
-   README.TXT (Ransom note)

### My files
-   *.json (OOAnalyzer generated file)
-   NOTPETYA (My Ghidra project folder)

## 63545fa195488ff51955f09833332b9660d18f8afb16bdf579134661962e548a.exe
This file is responsible for the execution of the malicious DLL.

There is not much to say about this executable, it simply writes the DLL into "%SystemRoot\perfc.dat" file, and then executes it. In particular, it load the #1 resource.

![The NotPetya's DLL "launcher"](https://github.com/Natisfaction/Reverse_Malware/blob/main/NotPetya/README_IMAGES/NotPetya_executable.png)

## perfc.dat
This is the malicious DLL

Firstly, the malware tries to acquire those privileges:
-   "SeShutdownPrivilege"
-   "SeDebugPrivilege"
-   "SeTcbPrivilege"

Then, it checks if a file called perfc exists. If the file exists, the malware exits the process without infecting the system. This may be a potential killswitch.

If the file does not exists, and only if the malware has acquired the admin privileges, it overrides the first 10 sectors of the disk, skipping the first one.

Then it creates the "Fake CHKDSK" NTFS check on the MBR. If the MBR ovverride wasn't successfull, the malware also overwrite the first disk sector, making it unable to boot.

Then it schedules a system shutdown using this command:
-   "schtasks /RU "SYSTEM" /Create /SC once /TN "" /TR shutdown.exe /r /f /ST **hour**:**minute**"

However, if it detects that the system is XP or prior, the command is the following:
-   "at **hour**:**minute** shutdown.exe /r /f"

Then it tries to "propagate" on the network using EternalBlue exploit.
After that, it drops a file from the resource number 1, called ***"random_str".dat***, that will attempt to steal credentials from the lsass.exe Windows process.

It then launches a thread, and with the stolen resources, it tries itself on the \\\\HOST\admin$\ folder, and then try to execute itself on other computers using another dropped file, from resource number 3, called ***dllhost.dat***, and runs it to try to run the malware on other network machines with SYSTEM privileges. If the execution fails, it just tries to use the Windows Management Instrumentation (WMI) to do the same thing.

Then the real ransomware thread is started, it looks for those file extensions:
-   ".3ds .7z .accdb .ai .asp .aspx .avhd .back .bak .c .cfg .conf .cpp .cs .ctl .dbf .disk .djvu .doc .docx .dwg .eml .fdb .gz .h .hdd .kdbx .mail .mdb .msg .nrg .ora .ost .ova .ovf .pdf .php .pmf .ppt .pptx .pst .pvi .py .pyc .rar .rtf .sln .sql .tar .vbox .vbs .vcb .vdi .vfd .vmc .vmdk .vmsd .vmx .vsdx .vsv .work .xls .xlsx .xvd .zip"

Following, it drops a README.TXT file on the Windowd Root folder.

Then the malware attemp to remove the system journal with the following command:
-   "wevtutil cl Setup & wevtutil cl System & wevtutil cl Security & wevtutil cl Applicatio n & fsutil usn deletejournal /D %c:"

And then it tries to shutdown the machine in 3 different ways:
-   Raising an hard error using **NtRaiseHardError** function
-   Initiate a system shutdown using **InitiateSystemShutdownExW** function
-   "killing" Windows using the **ExitWindowsEx** function

![Shutdown "modes"]()

Then a fake CHKSDK window is diplayed (part of malware payload).

![Fake CHKDSK]()

And then, at next reboot, the malware note.

![Malware Note]()

## 4ACF.dat
I'm my case, this was the file dropped in my test machine.

## dllhost.dat
According to [Microsoft](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec) this is a remote control program. This was used by NotPetya maliciously to execute the malware on other machines.

This program gets launched with this command line:
-   "cmd.exe \\\\dllhost.dat -accepteula -s -d C:\Windows\System32\rundll32.exe "C:\Windows\perfc.dat",#1" 

If the command fails, then the malware uses this command:
-   "C:\Windows\System32\wbem\wmic.exe /node:**node** /user:**user** /password:**password** process call create "C:\Windows\System32\rundll32.exe \"C:\Windows\perfc.dat\" #1 "

### Details
This file has the following attributes:
-   CompanyName:            "Sysinternals - www.sysinternals.com"
-   FileDescription:        "Execute processes remotely"
-   FileVersion:            "1.98"
-   InternalName:           "PsExec"
-   LegalCopyright:         "Copyright (C) 2001-2010 Mark Russinovich"
-   OriginalFilename:       "psexec.c"
-   ProductName:            "Sysinternals PsExec"
-   ProductVersion:         "1.98"
-   Translation:            "4600409"

## Additional notes
Strange string found on NotPetya (maybe a key?):
-   "MIIBCgKCAQEAxP/VqKc0yLe9JhVqFMQGwUITO6WpXWnKSNQAYT0O65Cr8PjIQInTeHkXEjfO2n2JmURWV/uHB0ZrlQ/wcYJBwLhQ9EqJ3iDqmN19Oo7NtyEUmbYmopcq+YLIBZzQ2ZTK0A2DtX4GRKxEEFLCy7vP12EYOPXknVy/+mf0JFWixz29QiTf5oLu15wVLONCuEibGaNNpgq+CXsPwfITDbDDmdrRIiUEUw6o3pt5pNOskfOJbMan2TZu6zfhzuts7KafP5UA8/0Hmf5K3/F9Mf9SE68EZjK+cIiFlKeWndP0XfRCYXI9AJYCeaOu7CXF6U0AVNnNjvLeOn42LHFUK4o6JwIDAQAB"